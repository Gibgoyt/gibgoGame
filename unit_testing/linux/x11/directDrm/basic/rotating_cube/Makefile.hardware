# GibgoCraft Hardware-Direct Graphics Makefile
# Compiles the custom GPU hardware access layer
# NO VULKAN DEPENDENCIES!

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g -O2

# Source files for our hardware-direct graphics system
SOURCES = main_hardware.c \
          gibgo_graphics.c \
          gpu_device.c \
          gpu_memory.c \
          gpu_commands.c \
          shader_data.c \
          cube_geometry.c \
          uniform_buffer.c

# Object files
OBJECTS = $(SOURCES:.c=.o)

# Target executable
TARGET = triangle_hardware

# System libraries (NO Vulkan! Uses DRM for direct GPU access)
LIBS = -lX11 -lm -ldrm

# Header dependencies
HEADERS = types.h math.h gpu_device.h gibgo_graphics.h \
          cube_geometry.h uniform_buffer.h camera.h animation.h

# Default target
all: shaders $(TARGET)

# Compile shaders first
shaders: shader_data.c

shader_data.c: vertex.vert fragment.frag compile_shaders_hardware.sh
	@echo "ðŸŽ¨ Compiling shaders for hardware-direct graphics..."
	./compile_shaders_hardware.sh

# Main executable
$(TARGET): $(OBJECTS)
	@echo "ðŸ”— Linking hardware-direct graphics executable..."
	$(CC) $(OBJECTS) -o $(TARGET) $(LIBS)
	@echo "âœ… Hardware-direct graphics executable built: $(TARGET)"

# Object file compilation
%.o: %.c $(HEADERS)
	@echo "ðŸ”§ Compiling $< (hardware-direct)..."
	$(CC) $(CFLAGS) -c $< -o $@

# Clean build artifacts
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -f $(OBJECTS) $(TARGET)
	rm -f shader_data.c
	rm -rf shaders_compiled/
	@echo "âœ… Clean complete"

# Debug build
debug: CFLAGS += -DDEBUG -g3
debug: $(TARGET)
	@echo "ðŸ› Debug build complete"

# Release build
release: CFLAGS += -O3 -DNDEBUG
release: clean $(TARGET)
	@echo "ðŸš€ Release build complete"

# Install (requires root for hardware access)
install: $(TARGET)
	@echo "ðŸ“¦ Installing $(TARGET)..."
	sudo cp $(TARGET) /usr/local/bin/
	sudo chmod +s /usr/local/bin/$(TARGET)  # Set setuid for hardware access
	@echo "âš ï¸  Note: Program installed with setuid for hardware access"
	@echo "âœ… Installation complete"

# Run with appropriate privileges
run: $(TARGET)
	@echo "ðŸŽ® Running hardware-direct graphics demo..."
	@echo "âš ï¸  Note: This requires root privileges for direct hardware access"
	sudo ./$(TARGET)

# Test compilation without linking
test-compile:
	@echo "ðŸ§ª Testing compilation of all modules..."
	$(CC) $(CFLAGS) -c main_hardware.c -o test_main.o
	$(CC) $(CFLAGS) -c gibgo_graphics.c -o test_graphics.o
	$(CC) $(CFLAGS) -c gpu_device.c -o test_device.o
	$(CC) $(CFLAGS) -c gpu_memory.c -o test_memory.o
	$(CC) $(CFLAGS) -c gpu_commands.c -o test_commands.o
	rm -f test_*.o
	@echo "âœ… All modules compile successfully"

# Analyze the differences from Vulkan version
diff-analysis:
	@echo "ðŸ“Š Analyzing differences from Vulkan implementation..."
	@if [ -f main.c ]; then \
		echo "Lines of code comparison:"; \
		echo "  Vulkan version: $$(wc -l main.c | cut -d' ' -f1) lines"; \
		echo "  Hardware-direct: $$(wc -l main_hardware.c | cut -d' ' -f1) lines"; \
		echo "  Graphics layer: $$(wc -l gibgo_graphics.c gpu_device.c gpu_memory.c gpu_commands.c | tail -1 | cut -d' ' -f1) lines"; \
		echo ""; \
		echo "Dependencies removed:"; \
		echo "  âŒ libvulkan"; \
		echo "  âŒ Vulkan headers"; \
		echo "  âŒ SPIR-V compiler (for now)"; \
		echo ""; \
		echo "Dependencies added:"; \
		echo "  âœ… Direct hardware access"; \
		echo "  âœ… Custom memory management"; \
		echo "  âœ… Custom command submission"; \
	else \
		echo "âš ï¸  Original main.c not found for comparison"; \
	fi

# Development help
help:
	@echo "ðŸŽ¯ gibgoCraft Hardware-Direct Graphics Build System"
	@echo "=================================================="
	@echo ""
	@echo "Available targets:"
	@echo "  all            - Build the hardware-direct graphics demo"
	@echo "  clean          - Remove build artifacts"
	@echo "  debug          - Build with debug symbols and verbose output"
	@echo "  release        - Build optimized release version"
	@echo "  install        - Install with setuid for hardware access (requires sudo)"
	@echo "  run            - Run the demo with appropriate privileges"
	@echo "  test-compile   - Test compilation of all modules"
	@echo "  diff-analysis  - Compare with Vulkan implementation"
	@echo "  help           - Show this help message"
	@echo ""
	@echo "Requirements:"
	@echo "  - gcc with C99 support"
	@echo "  - X11 development libraries (libX11-dev)"
	@echo "  - Root access for direct hardware control"
	@echo ""
	@echo "âš ï¸  WARNING: This program accesses GPU hardware directly!"
	@echo "   Make sure you understand the implications before running."

# Dependency tracking
.PHONY: all clean debug release install run test-compile diff-analysis help